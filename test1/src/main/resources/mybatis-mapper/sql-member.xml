<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.test1.mapper.MemberMapper">
	<select id="memberLogin" parameterType="hashmap" resultType="com.example.test1.model.Member">
		SELECT *
		FROM TBL_USER
		WHERE USERID = #{id} 
		<!-- AND PASSWORD = #{pwd} 해시 적용 후 제거 -->
	</select>
	
	<select id="idCheck" parameterType="hashmap" resultType="com.example.test1.model.Member">
		SELECT *
		FROM TBL_USER
		WHERE USERID = #{id}
	</select>
	
	<insert id="memberJoin" parameterType="hashmap" useGeneratedKeys="true" keyColumn="USERID" keyProperty="userId">
		INSERT INTO TBL_USER (USERID, PASSWORD, NAME, ADDRESS, PHONE, GENDER, STATUS)
		VALUES(#{id}, #{hashPwd}, #{name}, #{addr}, #{phone}, #{gender}, #{status})
	</insert>
	
	<insert id="insertUserImg" parameterType="hashmap">
		INSERT INTO TBL_USER_FILE
		VALUES(USERFILE_SEQ.NEXTVAL, #{userId}, #{path}, #{fileName}, #{orgName}, #{size}, #{ext})
	</insert>
	
	<select id="memberList" parameterType="hashmap" resultType="com.example.test1.model.Member">
		SELECT U.*, DECODE(BIRTH, NULL, '정보없음', SUBSTR(BIRTH, 3, 2) || '.' || SUBSTR(BIRTH, 5, 2) || '.' || SUBSTR(BIRTH, 7, 2)) AS NEWBIRTH
		FROM TBL_USER U
		WHERE 
			(USERID LIKE '%' || #{keyword} || '%' OR NAME LIKE '%' || #{keyword} || '%')
		OFFSET #{page} ROWS FETCH NEXT #{pageSize} ROWS ONLY
	</select>
	
	<select id="selectMemberCnt" parameterType="hashmap" resultType="int">
		SELECT COUNT(*)
		FROM TBL_USER
		WHERE 
			(USERID LIKE '%' || #{keyword} || '%' OR NAME LIKE '%' || #{keyword} || '%')
	</select>
	
	<update id="loginFail" parameterType="hashmap">
		UPDATE TBL_USER
		SET CNT = CNT + 1 
		WHERE USERID = #{id}
	</update>
	
	<update id="loginInit" parameterType="hashmap">
		UPDATE TBL_USER
		SET CNT = 0
		WHERE USERID = #{id}
	</update>
	
	<select id="memberCheck" parameterType="hashmap" resultType="com.example.test1.model.Member">
		SELECT *
		FROM TBL_USER
		WHERE USERID = #{id} AND NAME = #{name} AND REPLACE(PHONE, '-', '') = REPLACE(#{phone}, '-', '')
	</select>
	
	<update id="pwdChange" parameterType="hashmap">
		UPDATE TBL_USER
		SET PASSWORD = #{hashPwd}
		WHERE USERID = #{id}
	</update>
</mapper>




